# Enhanced Spec-Driven Orchestrator Design (v1.2)

**Version:** 1.2
**Date:** 2025-11-17
**Status:** Design Phase
**Owner:** Spec-Driven Team
**Implementation:** Built using Tanstack Start framework (not Next.js)

**Constraints & Scope (Updated)**

- **LLM:** Google **Gemini 2.5 Flash only** for all agents and phases (no model routing / multi-LLM).
- **Agent Execution:** Agents run **sequentially** by phase (no parallel agent execution in v1.1).
- **Customization:** Orchestrator remains a **static YAML spec** (no end-user agent builder / DSL in MVP).
- **Distribution:** **No template marketplace** in MVP.
- **Handoff:** Single, unified **`HANDOFF.md`** prompt format (LLM-agnostic, but designed to work well with Gemini, Claude, GPT, local models).
- **Platform Architecture:** Backend orchestration + LLM integration as previously designed (no major change to core architecture in this document).
- **Framework Decision:** **Tanstack Start** for the orchestrator platform itself (not Next.js).

---

## Canonical Generated Project Tech Stack (NEW)

For **project creation / scaffolding output**, the orchestrator now has a **canonical Next.js stack** that all generated projects should default to, unless the user explicitly chooses a custom stack.

### 1. Core Tech Stack

- **Framework:** Next.js (App Router) - for generated projects
- **Language:** TypeScript
- **Database:** PostgreSQL on managed **Neon**
- **ORM:** **Drizzle ORM**
- **Auth:** **Better Auth**
  - Installed via: `pnpm install better-auth`
- **Package Manager:** **pnpm**
- **Monorepo:** **TurboRepo**
- **Validation:** **Zod**
- **Linting:** **ESLint** (with TypeScript + Next.js presets)
- **Styling:** Tailwind CSS
- **Component Library:** **shadcn/ui**
  - Initialized via: `pnpm dlx shadcn@latest init`

### 2. Shadcn / UI Implementation Rules

To ensure consistent, high-quality UI output from the orchestrator's generated specs:

1. **Always use shadcn components over custom components.**
2. **Never** hand-roll duplicate UI primitives; instead:
   - Use: `pnpm dlx shadcn@latest add <component>`  
     Example: `pnpm dlx shadcn@latest add button`
3. **Always use the standard Tailwind + shadcn color tokens.**
   - No arbitrary hex values or ad-hoc colors in class names.
   - Use `bg-primary`, `text-muted-foreground`, etc., not `bg-[#123456]`.
4. **Never use inline custom colors.**
   - No `style={{ color: "#fff" }}` in React components.
   - If a new color is truly needed, it must be added to the theme via Tailwind config (handled manually by the user / team, not auto-generated by the LLM spec).
5. All UI layout specs should reference **shadcn semantics**:
   - e.g., "Use `Card`, `Button`, `Input`, `Dialog` from shadcn" instead of "create a custom styled `<div>`".

### 3. Canonical Project Folder Convention (Generated Apps)

Generated projects should default to a **TurboRepo monorepo** layout like:

```text
apps/
  web/          # Next.js app
  admin/        # Optional second Next.js app
packages/
  ui/           # Shared shadcn-based design system
  api/          # Shared types, Zod schemas, API hooks
  config/       # ESLint, tsconfig, tailwind config, etc.
```

Database (Neon + Drizzle) and Better Auth integration should be defined as **first-class sections** in `architecture.md`, `DEPENDENCIES.md`, and `tasks.md` for every generated project.

---

## 1. Executive Summary

Spec-Driven is evolving into a **spec-first orchestration platform** that guides a project from vague idea → complete, production-grade specification folder. Users then plug this folder into their IDE + LLM to generate code.

Key principle: **Spec generation is separate from code generation.**  
Spec-Driven never writes app code; it generates **structured, validated specs** and a polished **`HANDOFF.md`** that any LLM can follow.

**Highlights in v1.1:**

- Formal **orchestrator spec** (`orchestrator_spec.yml`) describing phases, agents, artifacts, validators, gates.
- Explicit **approval gates** for tech stack and dependencies.
- Multi-agent system: **Analyst, PM, Architect, Scrum Master, DevOps** (all powered by Gemini 2.5 Flash).
- Auto-generated **`HANDOFF.md`** with a ready-to-paste prompt for code generation.
- **Canonical Next.js + Neon + Drizzle + Better Auth + shadcn** stack for generated projects.
- **Cross-artifact validation** (PRD ↔ API spec ↔ data model ↔ tasks).
- **Traceability matrix** (`traceability.json`) to link requirements → tasks → APIs → tables.
- **GitHub integration** for one-click repo creation + spec validation workflow.
- **SBOM** generation (CycloneDX) for dependency transparency.
- **Token economy + quality scoring** per phase to reduce bad artifacts and control LLM cost.

---

## 2. System Vision

### The Problem

Most AI-assisted dev today is **vibe coding**:

- Long, unstructured prompts.
- No stable spec to return to.
- Poor separation between requirements, architecture, and tasks.
- Impossible to audit or iterate systematically.

### The Solution

Spec-Driven becomes a **"spec engine"** that behaves like a small virtual product team:

- **Analyst Agent** — asks structured questions and captures the vision.
- **PM Agent** — writes a full PRD with scoped requirements and MVP vs Phase 2 features.
- **Architect Agent** — designs architecture and data model; proposes and records the tech stack.
- **DevOps Agent** — defines dependencies, security posture, SBOM.
- **Scrum Master Agent** — breaks work into tasks with context and acceptance criteria.

The orchestrator runs these agents in **6 ordered phases**, saves all artifacts, validates them, and then generates a `HANDOFF.md` + ZIP (and/or GitHub repo) for the user to code from.

### Why This Approach Works

- **Separation of concerns** – Specs first, code later.
- **Reproducibility** – Specs are files, versionable and auditable.
- **LLM-agnostic** – Any capable LLM can consume the specs.
- **Safety & Quality** – Validators, gates, security baseline, and SBOM.
- **Scalability** – Same pattern scales from small MVPs to complex systems.

---

## 3. Architecture Overview (High Level)

```text
┌─────────────────────────────────────────────────────────────┐
│                    FRONTEND (Tanstack Start)                │
│  Project list, wizard, phase stepper, review UI            │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  BACKEND Orchestrator API                   │
│                                                             │
│  Orchestrator Service      LLM Service (Gemini 2.5 Flash)   │
│  - Phase state machine     - Agent prompts & templates      │
│  - Gate validation         - Response parsing & scoring     │
│  - Cross-artifact checks   - Quality scoring                │
│  - Artifact management                                      │
│                                                             │
│  File/Storage Service      GitHub Integration Service       │
│  - Project dirs & files    - Create repo + PR + workflows   │
│  - ZIP archives            - Webhook handlers               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                On-Disk Specs & Project Artifacts            │
│  /projects/{slug}/                                         │
│   ├ specs/ (phase folders & versions)                      │
│   ├ docs/ (security, SBOM, traceability)                   │
│   ├ HANDOFF.md                                             │
│   └ metadata.json                                          │
└─────────────────────────────────────────────────────────────┘
```

**Note:** Frontend and backend stack for the orchestrator platform uses **Tanstack Start** for routing and UI. The canonical Next.js stack (mentioned in this document) applies to **generated projects only**, not the orchestrator platform itself.

---

## 4. Phase Workflow (Recap)

Phases are **strictly sequential in v1.1**:

```text
ANALYSIS
   ↓
STACK_SELECTION (gate)
   ↓
SPEC
   ↓
DEPENDENCIES (gate)
   ↓
SOLUTIONING
   ↓
DONE
```

### Phase 1 – ANALYSIS

- **Owner:** Analyst Agent
- **Input:** Project idea / high-level description.
- **Output:**
  - `constitution.md` – guiding principles, non-negotiables.
  - `project-brief.md` – vision, goals, market, scope.
  - `personas.md` – 3–5 detailed user personas.
- **Validation:**
  - All files exist and have frontmatter.
  - Content is non-trivial (length, structure checks).

### Phase 2 – STACK_SELECTION (Gate)

- **Owner:** Architect Agent (proposal), user (approval).
- **Input:** `project-brief.md`, `personas.md`.
- **Output:**
  - `plan.md` – project plan with approved stack.
  - `README.md` – project overview including tech stack.
  - `stack-proposal.md` – options with trade-offs.
  - `stack-scorecard.json` – cost / complexity / team-fit metrics.
- **Default Canonical Stack:**  
  Next.js + TS + Neon + Drizzle + Better Auth + Tailwind + shadcn/ui + Zod + ESLint + pnpm + TurboRepo.
- **Gate:** `stack_approved == true` set in `metadata.json`.

### Phase 3 – SPEC

- **Owner:** PM Agent + Architect Agent.
- **Input:** ANALYSIS outputs + approved stack.
- **Output:**
  - `PRD.md` – full Product Requirements Document.
  - `data-model.md` – data schema (Postgres tables, Drizzle models).
  - `api-spec.json` – OpenAPI spec.
  - Initial `traceability.json` – requirement IDs with references.
- **Cross-Artifact Checks:**
  - Every API endpoint maps to at least one requirement.
  - Data model supports all required flows.

### Phase 4 – DEPENDENCIES (Gate)

- **Owner:** DevOps Agent (proposal), user (approval).
- **Input:** `PRD.md`, approved stack.
- **Output:**
  - `DEPENDENCIES.md` – human-readable dependency list + rationale.
  - `dependency-proposal.json` (or `.md`) – structured form.
  - `sbom.json` – CycloneDX SBOM.
  - Lockfiles (e.g. `pnpm-lock.yaml` for Node).
- **Gate:** `dependencies_approved == true`.
- **Security Checks:**
  - No HIGH/CRITICAL vulnerabilities (audit tools).
  - No deprecated / severely outdated packages.

### Phase 5 – SOLUTIONING

- **Owner:** Architect Agent + Scrum Master Agent.
- **Input:** All previous artifacts.
- **Output:**
  - `architecture.md` – system architecture (incl. Neon / Drizzle / Better Auth setup sections for canonical stack).
  - `epics.md` – epic-level breakdown.
  - `tasks.md` – detailed, context-rich tasks.
  - Updated `traceability.json` – requirements → tasks/APIs/tables.
- **Checks:**
  - Tasks form a DAG (no circular dependencies).
  - Every requirement has at least one linked task.

### Phase 6 – DONE

- **Owner:** Orchestrator.
- **Input:** All validated artifacts.
- **Output:**
  - `HANDOFF.md` – master handoff instructions + LLM prompt.
  - Root-level spec files (copied from phase folders).
  - Project ZIP archive.
  - Optional GitHub repository initialized with all files.
  - Final `metadata.json`.

---

## 5. Multi-Agent Roles & Prompts (Overview)

All agents are powered by **Gemini 2.5 Flash** and are invoked sequentially.

### 5.1 Analyst Agent

- **Phase:** ANALYSIS.
- **Goal:** Understand the vision, problem space, users, constraints.
- **Artifacts:** `constitution.md`, `project-brief.md`, `personas.md`.

Prompt characteristics:

- Ask targeted questions about users, pain points, market, constraints.
- Synthesize answers into three markdown documents, each with frontmatter.
- Capture non-negotiable principles (e.g. "must be mobile-first", "no PII logging").

### 5.2 Product Manager Agent (PM)

- **Phase:** SPEC.
- **Goal:** Turn vision into a detailed, scoped PRD.
- **Artifacts:** `PRD.md`.

Key behaviors:

- Create numbered requirements (`REQ-AREA-001` style).
- Mark requirements as **MVP** vs **Phase 2**.
- Map each requirement to one or more personas.
- Include clear acceptance criteria for every requirement.

### 5.3 Architect Agent

- **Phases:** STACK_SELECTION, SPEC, SOLUTIONING.
- **Goal:** Choose/record the stack, design the data model, API, and overall architecture.

Key responsibilities:

- Propose multiple stacks, with the canonical **Next.js + Neon + Drizzle + Better Auth** stack as **Option A**.
- Generate `stack-scorecard.json` with complexity/cost/team-fit.
- Define Drizzle models, Neon connection strategy, and Better Auth flows in `data-model.md` and `architecture.md`.
- Create `api-spec.json` that aligns with PRD requirements.
- In `architecture.md`, include sections for:
  - App layers (web, API, auth, data).
  - Integration details: Neon connection pooling, migrations, auth flows, etc.
  - Security baseline integrations.

### 5.4 Scrum Master Agent

- **Phase:** SOLUTIONING.
- **Goal:** Break spec into implementable tasks.

Outputs:

- `epics.md` – epics covering groups of requirements.
- `tasks.md` – each task contains:
  - ID, title, description.
  - Linked requirement IDs.
  - Linked epics.
  - References to sections in `architecture.md` and `api-spec.json`.
  - Implementation hints (Drizzle / Better Auth specifics where relevant).
  - Acceptance criteria, complexity, dependencies, and priority.

### 5.5 DevOps Agent

- **Phase:** DEPENDENCIES.
- **Goal:** Define dependencies, enforce policy, generate SBOM.

Outputs:

- `DEPENDENCIES.md`:
  - Node / Next.js + Drizzle + Better Auth + shadcn dependencies.
  - Tooling: ESLint, Prettier (if desired), testing tools, etc.
  - Rationale, version constraints, security and licensing notes.
- `sbom.json` (CycloneDX) – for all Node deps, possibly extended later.

---

## 6. Key Features & Enhancements (v1.1)

### 6.1 Canonical Next.js Stack (Neon + Drizzle + Better Auth + shadcn)

The orchestrator **biases all generated projects** toward the canonical stack unless the user chooses otherwise. This impacts:

- `stack-proposal.md`: Option A describes the canonical stack in detail.
- `plan.md` / `README.md`: Include a "Approved Tech Stack" section with this stack recorded.
- `architecture.md`: Contains a standard baseline architecture for this stack:
  - Next.js App Router.
  - Drizzle schema / migrations pattern.
  - Neon deployment notes.
  - Better Auth usage and session strategy.
  - Shared UI package built with shadcn and Tailwind.
- `tasks.md`: Contains tasks like:
  - "Set up pnpm + TurboRepo."
  - "Initialize Next.js App Router project."
  - "Configure Drizzle with Neon."
  - "Integrate Better Auth."
  - "Install shadcn and add core components (button, input, card, dialog)."

### 6.2 Cross-Artifact Validation

The orchestrator runs cross-checks such as:

- **Requirements ↔ APIs:** each endpoint in `api-spec.json` maps to at least one requirement.
- **Requirements ↔ Data model:** required entities / relationships exist.
- **Requirements ↔ Tasks:** all requirements are covered by tasks.
- **Stack ↔ Dependencies:** `DEPENDENCIES.md` matches the approved stack (e.g., Drizzle is present when Drizzle is chosen).

Failures block progression until corrected.

### 6.3 Requirement Traceability Matrix

`traceability.json` tracks coverage:

```json
{
  "REQ-AUTH-001": {
    "tasks": ["TASK-1.1", "TASK-1.2"],
    "api_endpoints": ["POST /api/auth/register"],
    "database_tables": ["users"],
    "test_cases": []
  }
}
```

This supports:

- Impact analysis when a requirement changes.
- Coverage reporting (must reach 100% before DONE).

### 6.4 GitHub Integration

Optional but highly valuable:

- Create private repo with one click.
- Commit all specs and docs.
- Open an initial PR with `HANDOFF.md` as description.
- Attach a GitHub Actions workflow to re-run validators on push.

### 6.5 Token Economy & Quality Scoring

For each phase, the orchestrator records approximate token usage and basic quality scores (0–100) for each artifact. Low scores can trigger automatic regeneration (still within Gemini 2.5 Flash).

---

## 7. Canonical Stack: Dependency Guidelines (Generated Projects)

This section defines a **recommended `DEPENDENCIES.md` outline** when the canonical Next.js stack is chosen.

### 7.1 Node / Next.js Dependencies

**Core:**

- `next` – Next.js (App Router).
- `react`, `react-dom` – React core packages.
- `typescript` – TypeScript support.
- `zod` – runtime validation and schema definitions.
- `drizzle-orm` – ORM layer.
- `pg` or `@neondatabase/serverless` – PostgreSQL / Neon driver.

**Auth:**

- `better-auth` – authentication + session handling.

**Styling & UI:**

- `tailwindcss`, `postcss`, `autoprefixer` – Tailwind toolchain.
- `clsx` / `class-variance-authority` (optional) – for variant handling.
- `@radix-ui/react-*` – underlying primitives (installed as needed by `shadcn`).
- `lucide-react` – icons.
- `shadcn/ui` (initialized via CLI, not as a plain npm package).

**Tooling:**

- `eslint` + `@typescript-eslint/*` + `eslint-config-next` – linting.
- Prettier (optional) – formatting.
- `turbo` – for TurboRepo monorepo orchestration.
- Testing stack (e.g., `vitest`, `@testing-library/react`, `playwright`) as appropriate.

### 7.2 Tailwind / shadcn Rules in Specs

The orchestrator's generated specs should clearly state:

- "Use shadcn-provided components for buttons, cards, inputs, dialogs, dropdowns, etc."
- "Install components via `pnpm dlx shadcn@latest add <component>`; do not re-implement primitives."
- "Use Tailwind utility classes and the shadcn theme tokens for color, typography, spacing."
- "No inline styles or manual hex colors; rely on design tokens."

### 7.3 Example DEPENDENCIES.md Structure (Canonical Stack)

A simplified example section the DevOps Agent might generate:

```md
# Dependencies

## Core Framework & Language

- **next@14.x** – React framework with App Router.
- **react@18.x**, **react-dom@18.x** – UI library.
- **typescript@5.x** – Static typing.

## Database & ORM

- **drizzle-orm@^0.x**
- **@neondatabase/serverless@^0.x**

Rationale: Type-safe SQL and migrations, Neon managed Postgres.

## Auth

- **better-auth@latest**

Rationale: Opinionated, modern auth library, integrates well with Next.js.

## Styling & Components

- **tailwindcss@^3.x**, **postcss@^8.x**, **autoprefixer@^10.x**
- **shadcn/ui** (installed via CLI)
- **lucide-react@latest**

Guidelines: Use shadcn components only; no custom primitive components.

## Validation & Utilities

- **zod@^3.x** – Validation and types.

## Tooling

- **eslint@^9.x**, **@typescript-eslint/eslint-plugin**, **@typescript-eslint/parser**, **eslint-config-next** – Linting.
- **turbo@latest** – Monorepo orchestration.
```

Security and license notes follow under each section, plus a summary of audit results.

---

## 8. Handoff & ZIP Structure

### 8.1 `HANDOFF.md` (Updated Stack Section)

The `HANDOFF.md` must include an explicit **Approved Tech Stack** section similar to:

```md
## Approved Technology Stack

**Frontend / Full Stack**

- Next.js (App Router) + React + TypeScript
- Tailwind CSS for styling
- shadcn/ui for components (installed via CLI, no custom primitives)
- Zod for validation

**Database & ORM**

- PostgreSQL on Neon (managed)
- Drizzle ORM (migrations + type-safe queries)

**Auth**

- Better Auth for authentication and session management

**Tooling**

- pnpm for package management
- TurboRepo for monorepo orchestration
- ESLint (TypeScript + Next.js config) for linting
```

The prompt section in `HANDOFF.md` should instruct the LLM:

- To use **only these dependencies** (unless explicitly extended by the user).
- To install shadcn components via CLI.
- To follow the directory and monorepo layout defined.

### 8.2 ZIP Structure

Downloaded ZIP structure (simplified):

```text
{project-slug}/
  HANDOFF.md
  README.md
  constitution.md
  project-brief.md
  personas.md
  specs/
    PRD.md
    data-model.md
    api-spec.json
    architecture.md
    epics.md
    tasks.md
    plan.md
    DEPENDENCIES.md
    stack-scorecard.json
  .ai-config/
    analyst_prompt.md
    pm_prompt.md
    architect_prompt.md
    scrummaster_prompt.md
    devops_prompt.md
    validators.yml
  docs/
    security-baseline.md
    DEPS_NOTES.md
    sbom.json
    traceability.json
```

---

## 9. API Surface (Outline)

Only a brief outline (full OpenAPI spec is generated as `api-spec.json`).

- `GET /api/projects` – list projects.
- `POST /api/projects` – create project.
- `GET /api/projects/{slug}` – get project details.
- `GET /api/projects/{slug}/phase` – current phase state.
- `POST /api/projects/{slug}/phase/advance` – advance to next phase (if gates pass).
- `GET /api/projects/{slug}/stack/proposal` – view stack proposal.
- `POST /api/projects/{slug}/stack/approve` – approve stack choice.
- `GET /api/projects/{slug}/dependencies/proposal` – view dependency proposal.
- `POST /api/projects/{slug}/dependencies/approve` – approve dependencies.
- `GET /api/projects/{slug}/traceability` – view requirement coverage.
- `GET /api/projects/{slug}/download` – download ZIP.
- `POST /api/projects/{slug}/github/push` – create GitHub repo + PR.

Implementation details (models, DTOs, etc.) follow the original v1.1 design, with no change other than the **canonical stack content** in spec-related endpoints.

---

## 10. Data Models (Key Fields Only)

### 10.1 Project

- `id: UUID`
- `slug: str`
- `name: str`
- `description: str`
- `current_phase: str`
- `phases_completed: list[str]`
- `stack_choice: Optional[str]` (e.g. `"nextjs_neon_drizzle_betterauth"`)
- `stack_approved: bool`
- `dependencies_approved: bool`
- `github_repo_url: Optional[str]`
- `orchestration_state: dict` (artifact versions, validation results, token usage)
- `created_at`, `updated_at`

### 10.2 PhaseHistory

Tracks transitions:

- `project_id`
- `from_phase`, `to_phase`
- `artifacts_generated: list[str]`
- `validation_passed: bool`
- `tokens_used: Optional[int]`
- `cost_estimate_usd: Optional[float]`
- `transitioned_by: user id`
- `transition_date`

### 10.3 ProjectArtifact

Per-artifact tracking:

- `project_id`
- `phase`
- `artifact_name`
- `version`
- `file_path`
- `file_size`
- `content_hash`
- `frontmatter: dict`
- `validation_status: "pending" | "pass" | "warn" | "fail"`
- `validation_errors: list[str]`
- `quality_score: float`

### 10.4 RequirementTraceability

- `project_id`
- `requirement_id`
- `requirement_title`
- `tasks: list[str]`
- `api_endpoints: list[str]`
- `database_tables: list[str]`
- `test_cases: list[str]`
- `fully_implemented: bool`

---

## 11. Implementation Roadmap (High Level)

### MVP (Weeks 1–4)

1. **Week 1 – Orchestrator Core**

   - Implement phase state machine.
   - Implement gate checks and basic validators.
   - Persist artifacts and metadata to disk + DB.
   - Load `orchestrator_spec.yml` (static).

2. **Week 2 – LLM + ANALYSIS & SPEC**

   - Wrap Gemini 2.5 Flash.
   - Implement Analyst Agent for ANALYSIS.
   - Implement PM Agent + Architect Agent for SPEC.
   - Add quality scoring and simple retry logic.

3. **Week 3 – DEPENDENCIES & SOLUTIONING**

   - Implement DevOps Agent (`DEPENDENCIES.md`, `sbom.json`).
   - Implement Scrum Master Agent (`epics.md`, `tasks.md`).
   - Add `traceability.json` generation.

4. **Week 4 – DONE, GitHub, Handoff**
   - Generate `HANDOFF.md` from templates.
   - ZIP creation + download endpoint.
   - GitHub integration (repo + PR + workflow).
   - E2E tests for full project run.

### Phase 2+ (Post-MVP)

- Better review UI: diffs, inline comments, conditional approvals.
- Analytics dashboard for token usage / artifact quality.
- Enterprise policy layer (allowed stacks, banned packages, etc.).

---

## 12. Technical Decisions (Updated)

1. **LLM Choice**

   - **Decision:** Use Gemini 2.5 Flash exclusively.
   - **Reason:** Cost-effective, fast enough for interactive flows, adequate for spec-generation tasks.
   - **Implication:** No routing between models; rely on quality scoring + retries to catch low-quality outputs.

2. **Sequential Agents**

   - **Decision:** Keep phases strictly sequential.
   - **Reason:** Simpler reasoning & debugging; easier for users to understand progression.
   - **Trade-off:** Slightly slower end-to-end; mitigated by progress UI and partial-phase re-runs.

3. **Static Orchestrator Spec**

   - **Decision:** No end-user DSL / agent builder in MVP.
   - **Reason:** Reduce complexity; maintain a single, battle-tested YAML spec.
   - **Path forward:** Future version might add "advanced customization mode" if needed.

4. **No Marketplace**

   - **Decision:** No public template/gallery in MVP.
   - **Reason:** Stay focused on core orchestrator and project creation; avoid moderation / curation complexity.

5. **Unified `HANDOFF.md`**

   - **Decision:** One prompt format, LLM-agnostic.
   - **Reason:** Easy to maintain, works across popular LLMs; users can adapt as needed.

6. **Security Baseline**

   - **Decision:** Include a security baseline in every project.
   - **Reason:** Shift security left; keep minimal but non-negotiable rules (auth, transport security, basic logging).

7. **Canonical Stack Bias**

   - **Decision:** Default to Next.js + Neon + Drizzle + Better Auth + shadcn and reflect that everywhere in specs.
   - **Reason:** Gives you (the user) a consistent, opinionated, modern stack for most projects.

8. **Orchestrator Framework Choice**
   - **Decision:** Use **Tanstack Start** for the orchestrator platform itself.
   - **Reason:** Modern React framework with excellent routing, TypeScript support, and developer experience.
   - **Note:** This applies to the **orchestrator platform**, not to generated projects which still default to Next.js.

---

## 13. Success Criteria

For an MVP project run to be considered successful:

- All 6 phases complete without validation errors.
- `stack_approved` and `dependencies_approved` are both `true`.
- `PRD.md` contains well-structured requirements with IDs and acceptance criteria.
- `api-spec.json` is syntactically valid OpenAPI and maps to requirements.
- `data-model.md` defines all necessary entities/relations (including Neon / Drizzle specifics).
- `tasks.md` covers all requirements and is DAG-valid.
- `sbom.json` generated; audits show no HIGH/CRITICAL vulnerabilities.
- `traceability.json` shows 100% requirement coverage.
- `HANDOFF.md` includes canonical tech stack details and a clear instructions prompt.
- The user can paste `HANDOFF.md` + folder into an IDE LLM and generate functioning code aligned with the specs.

---

## 14. Glossary

- **Artifact:** Generated file (markdown/JSON) such as `PRD.md` or `api-spec.json`.
- **Phase:** Top-level stage in the orchestrator workflow (ANALYSIS, SPEC, etc.).
- **Gate:** Condition that must be met to advance from one phase to the next.
- **Agent:** LLM role (Analyst, PM, Architect, Scrum Master, DevOps).
- **Handoff:** Process of giving the spec folder + prompt to the user's IDE / LLM for code generation.
- **SBOM:** Software Bill of Materials (CycloneDX) listing dependencies.
- **Traceability:** Mapping from requirements to implementation artifacts (tasks, APIs, data tables).
- **Orchestrator Platform:** The Tanstack Start-based application that runs the orchestration process (not the generated projects).
- **Generated Projects:** The Next.js-based projects created by the orchestrator for end users.

---

## 15. Document History

| Version | Date       | Author | Notes                                                                                                                                                                                                       |
| ------- | ---------- | ------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1.0     | 2025-11-14 | Team   | Initial orchestrator design with phases, agents, and core features.                                                                                                                                         |
| 1.1     | 2025-11-17 | Team   | Added canonical Next.js stack, traceability, SBOM, GitHub, token tracking; constrained to Gemini 2.5 Flash; clarified no marketplace / static spec; integrated Neon + Drizzle + Better Auth + shadcn rules. |
| 1.2     | 2025-11-17 | Team   | **Updated Framework Choice**: Specified Tanstack Start for the orchestrator platform (not Next.js). Next.js remains the canonical stack for **generated projects only**.                                    |
